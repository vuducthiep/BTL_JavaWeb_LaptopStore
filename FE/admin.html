<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Dashboard</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  </head>
  <body>
    <div class="container mt-5">
      <h1 class="text-center">Dashboard</h1>
      <div class="row">
        <!-- Dashboard Stats -->
        <div class="col-md-3">
          <div class="card">
            <div class="card-body">
              <h5 class="card-title">Sản phẩm trong tháng</h5>
              <p id="quantity-sell-product-current-month">0</p>
            </div>
          </div>
        </div>

        <div class="col-md-3">
          <div class="card">
            <div class="card-body">
              <h5 class="card-title">Khách hàng trong tháng</h5>
              <p id="total-customer-in-current-month">0</p>
            </div>
          </div>
        </div>

        <div class="col-md-3">
          <div class="card">
            <div class="card-body">
              <h5 class="card-title">Khách hàng mới</h5>
              <p id="total-new-customer-in-current-month">0</p>
            </div>
          </div>
        </div>

        <div class="col-md-3">
          <div class="card">
            <div class="card-body">
              <h5 class="card-title">Doanh thu</h5>
              <p id="total-amount-in-current-month">0</p>
            </div>
          </div>
        </div>
      </div>

      <div class="row mt-5">
        <div class="col-md-6">
          <h3>Biểu đồ khách hàng mới</h3>
          <canvas id="new-customers-chart"></canvas>
        </div>

        <div class="col-md-6">
          <h3>Biểu đồ doanh thu</h3>
          <canvas id="revenue-chart"></canvas>
        </div>
      </div>

      <div class="row mt-5">
        <div class="col-md-12">
          <h3>Biểu đồ sản phẩm bán</h3>
          <canvas id="products-sold-chart"></canvas>
        </div>
      </div>
    </div>

    <script>
      async function loadDashboardData() {
        try {
          const response = await fetch(
            "http://localhost:8080/admin/dashboard/"
          );
          const data = await response.json();

          // Cập nhật số liệu tổng quan
          document.getElementById(
            "quantity-sell-product-current-month"
          ).innerText = data.quantitySellProductCurrentMonth;
          document.getElementById("total-customer-in-current-month").innerText =
            data.totalCustomerInCurrentMonth;
          document.getElementById(
            "total-new-customer-in-current-month"
          ).innerText = data.totalNewCustomerInCurrentMonth;
          document.getElementById(
            "total-amount-in-current-month"
          ).innerText = `${data.totalAmountInCurrentMonth} VND`;

          // Dữ liệu cho biểu đồ khách hàng mới
          const newCustomerLabels = data.newCustomerPerMonthMap.map(
            (item) => `Tháng ${item.month}`
          );
          const newCustomerData = data.newCustomerPerMonthMap.map(
            (item) => item.customerCount
          );

          const ctx1 = document
            .getElementById("new-customers-chart")
            .getContext("2d");
          new Chart(ctx1, {
            type: "line", // Chọn kiểu biểu đồ đường đi
            data: {
              labels: newCustomerLabels, // Tháng
              datasets: [
                {
                  label: "Khách hàng mới",
                  data: newCustomerData, // Số lượng khách hàng mới
                  borderColor: "rgba(75, 192, 192, 1)", // Màu đường
                  fill: false, // Không tô màu dưới đường
                  tension: 0.1, // Làm mượt đường nối giữa các điểm
                  borderWidth: 2, // Độ dày đường
                },
              ],
            },
            options: {
              responsive: true,
              plugins: {
                legend: {
                  position: "top",
                },
                tooltip: {
                  callbacks: {
                    label: function (tooltipItem) {
                      return `${tooltipItem.raw} khách hàng`; // Hiển thị số khách hàng
                    },
                  },
                },
              },
              scales: {
                x: {
                  title: {
                    display: true,
                    text: "Tháng",
                  },
                },
                y: {
                  title: {
                    display: true,
                    text: "Số lượng khách hàng",
                  },
                  beginAtZero: true,
                },
              },
            },
          });

          // Dữ liệu cho biểu đồ doanh thu (biểu đồ đường thay vì cột)
          const revenueLabels = data.totalAmountPerMonthMap.map(
            (item) => `Tháng ${item.month}`
          );
          const revenueData = data.totalAmountPerMonthMap.map(
            (item) => item.totalAmount
          );

          const ctx2 = document
            .getElementById("revenue-chart")
            .getContext("2d");
          new Chart(ctx2, {
            type: "line", // Đổi thành biểu đồ đường
            data: {
              labels: revenueLabels,
              datasets: [
                {
                  label: "Doanh thu (VND)",
                  data: revenueData,
                  borderColor: "rgba(54, 162, 235, 1)", // Màu đường cho doanh thu
                  fill: false, // Không tô màu dưới đường
                  tension: 0.1, // Làm mượt đường nối
                  borderWidth: 2,
                },
              ],
            },
            options: {
              responsive: true,
              plugins: {
                legend: {
                  position: "top",
                },
                tooltip: {
                  callbacks: {
                    label: function (tooltipItem) {
                      return `${tooltipItem.raw} VND`; // Hiển thị doanh thu
                    },
                  },
                },
              },
              scales: {
                x: {
                  title: {
                    display: true,
                    text: "Tháng",
                  },
                },
                y: {
                  title: {
                    display: true,
                    text: "Doanh thu (VND)",
                  },
                  beginAtZero: true,
                },
              },
            },
          });

          // Dữ liệu cho biểu đồ sản phẩm bán (biểu đồ đường thay vì pie)
          const productsSoldLabels =
            data.totalQuantitySellProductPerMonthMap.map(
              (item) => `Tháng ${item.month}`
            );
          const productsSoldData = data.totalQuantitySellProductPerMonthMap.map(
            (item) => item.totalSold
          );

          const ctx3 = document
            .getElementById("products-sold-chart")
            .getContext("2d");
          new Chart(ctx3, {
            type: "line", // Đổi thành biểu đồ đường
            data: {
              labels: productsSoldLabels,
              datasets: [
                {
                  label: "Sản phẩm bán",
                  data: productsSoldData,
                  borderColor: "#FF5733", // Màu đường cho sản phẩm bán
                  fill: false, // Không tô màu dưới đường
                  tension: 0.1, // Làm mượt đường nối
                  borderWidth: 2,
                },
              ],
            },
            options: {
              responsive: true,
              plugins: {
                legend: {
                  position: "top",
                },
                tooltip: {
                  callbacks: {
                    label: function (tooltipItem) {
                      return `${tooltipItem.raw} sản phẩm`; // Hiển thị số sản phẩm
                    },
                  },
                },
              },
              scales: {
                x: {
                  title: {
                    display: true,
                    text: "Tháng",
                  },
                },
                y: {
                  title: {
                    display: true,
                    text: "Số lượng sản phẩm",
                  },
                  beginAtZero: true,
                },
              },
            },
          });
        } catch (error) {
          console.error("Lỗi khi tải dữ liệu từ API:", error);
        }
      }

      // Load data khi trang được load
      document.addEventListener("DOMContentLoaded", loadDashboardData);
    </script>
  </body>
</html>
